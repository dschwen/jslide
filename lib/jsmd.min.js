var jsmd=(function(){function a(t,u){this.x=t||0;this.y=u||0}a.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};a.prototype.len2=function(){return this.x*this.x+this.y*this.y};a.prototype.pbclen=function(u,x){var v=this.x-Math.round(this.x/u)*u,t=this.y-Math.round(this.y/x)*x;return Math.sqrt(v*v+t*t)};a.prototype.normalize=function(){var t=this.len();if(t===0){this.x=1;this.y=0}else{this.x/=t;this.y/=t}};a.distance=function(u,t){return Math.sqrt((u.x-t.x)*(u.x-t.x)+(u.y-t.y)*(u.y-t.y))};a.distance2=function(u,t){return(u.x-t.x)*(u.x-t.x)+(u.y-t.y)*(u.y-t.y)};a.pbcdistance=function(x,t,v,z){var y=x.x-t.x,u=x.y-t.y;y-=Math.round(y/v)*v;u-=Math.round(u/z)*z;return Math.sqrt(y*y+u*u)};a.pbcdistance2=function(x,t,v,z){var y=x.x-t.x,u=x.y-t.y;y-=Math.round(y/v)*v;u-=Math.round(u/z)*z;return y*y+u*u};a.prototype.wrap=function(t,u){this.x-=Math.floor(this.x/t)*t;this.y-=Math.floor(this.y/u)*u};a.prototype.dwrap=function(t,u){this.x-=Math.round(this.x/t)*t;this.y-=Math.round(this.y/u)*u};a.sub=function(u,t){return new a(u.x-t.x,u.y-t.y)};a.prototype.sub=function(t){this.x-=t.x;this.y-=t.y};a.add=function(u,t){return new a(u.x+t.x,u.y+t.y)};a.prototype.add=function(t){this.x+=t.x;this.y+=t.y};a.scale=function(u,t){return new a(u.x*t,u.y*t)};a.prototype.scale=function(t){this.x*=t;this.y*=t};a.smul=function(u,t){return u.x*t.x+u.y*t.y};a.prototype.smul=function(t){return this.x*t.x+this.y*t.y};a.prototype.proj=function(t){var u=this.smul(t);this.x=t.x*u;this.y=t.y*u};a.prototype.zero=function(){this.x=0;this.y=0};a.prototype.set=function(t){this.x=t.x;this.y=t.y};a.random=function(t,u){return new a(Math.random()*t,Math.random()*u)};function h(t,u){this.p=new a(t,u);this.v=new a(0,0);this.f=new a(0,0);this.t=0}function d(){this.r=3;this.color="rgb(255,0,0)";this.Z=1;this.m=1}function k(u,w,t,v){this.p=[new a(u,w),new a(t,v)];this.n=new a(v-w,u-t);this.n.normalize();this.c=new a(t-u,v-w);this.l=this.c.len();this.c.scale(1/this.l);this.f=new a(0,0);this.t=0}k.prototype.dist=function(u){var t=new a(this.p[0].x-u.x,this.p[0].y-u.y),v=-(t.x*this.c.x+t.y*this.c.y);if(v<=0){return t}else{if(v>=this.l){return new a(this.p[1].x-u.x,this.p[1].y-u.y)}else{t.proj(this.n);return t}}};function g(t,u){if(t===undefined){return u}for(i in u){if(u.hasOwnProperty(i)){}}}function o(t,v,u){this.atoms=[];this.barriers=[];this.types=[];this.interaction=[];this.w=t;this.h=v;this.canvas={};this.renderChain=[r,p,j];this.lc={};this.nl={dr:0,data:[],count:0};this.dt=0;this.step=0;this.time=0;this.drag=0.995}o.prototype.setInteraction=function(v,w){for(var u=0;u<2;++u){if(this.interaction[v[u]]===undefined){this.interaction[v[u]]=[]}this.interaction[v[u]][v[1-u]]=w}};o.prototype.setCutOff=function(w,v){var x=w+v,u,t;this.rm2=x*x;this.rp=v;this.rc=w;this.rc2=w*w;this.lc.nx=Math.max(3,Math.floor(this.w/x));this.lc.ny=Math.max(3,Math.floor(this.h/x));this.lc.dx=this.w/this.lc.nx;this.lc.dy=this.h/this.lc.ny;t=new Array(this.lc.nx);for(u=0;u<this.lc.nx;++u){t[u]=new Array(this.lc.ny)}this.lc.data=t};o.prototype.clearLinkcell=function(){var u,t;for(u=0;u<this.lc.nx;++u){for(t=0;t<this.lc.ny;++t){this.lc.data[u][t]=[]}}};o.prototype.updateLinkcell=function(){this.clearLinkcell();var v,u,t;for(t=0;t<this.atoms.length;++t){v=Math.floor(this.atoms[t].p.x/this.lc.dx)%this.lc.nx;u=Math.floor(this.atoms[t].p.y/this.lc.dy)%this.lc.ny;this.lc.data[v][u].push(t)}};o.prototype.clearNeighborlist=function(){for(var t=0;t<this.atoms.length;++t){this.nl.data[t]=[]}};o.prototype.updateNeighborlist=function(v){if(v!==undefined){this.nl.dr+=2*v;if(this.nl.dr<this.rp){return}}this.nl.dr=0;this.updateLinkcell();this.clearNeighborlist();var B,A,x,E,z,y,w,C,u,D,t=[[0,1],[1,this.lc.ny-1],[1,0],[1,1]];for(B=0;B<this.lc.nx;++B){for(A=0;A<this.lc.ny;++A){D=this.lc.data[B][A].length;for(z=0;z<D;++z){C=this.lc.data[B][A][z];for(y=z+1;y<D;++y){u=this.lc.data[B][A][y];if(jsmd.Vector.pbcdistance2(this.atoms[C].p,this.atoms[u].p,this.w,this.h)<this.rm2){this.nl.data[C].push(u)}}for(w=0;w<t.length;++w){x=(B+t[w][0])%this.lc.nx;E=(A+t[w][1])%this.lc.ny;for(y=0;y<this.lc.data[x][E].length;++y){u=this.lc.data[x][E][y];if(jsmd.Vector.pbcdistance2(this.atoms[C].p,this.atoms[u].p,this.w,this.h)<this.rm2){this.nl.data[C].push(u)}}}}}}this.nl.count++};o.prototype.updateForces=function(){var w,v,t,x,z,y,u;for(w=0;w<this.atoms.length;++w){this.atoms[w].f.x=0;this.atoms[w].f.y=0}for(w=0;w<this.barriers.length;++w){this.barriers[w].f.x=0;this.barriers[w].f.y=0}for(w=0;w<this.atoms.length;++w){for(t=0;t<this.nl.data[w].length;++t){v=this.nl.data[w][t];u=jsmd.Vector.sub(this.atoms[v].p,this.atoms[w].p);u.dwrap(this.w,this.h);z=u.len2();if(z<this.rc2){z=Math.sqrt(z);y=this.interaction[this.atoms[w].t][this.atoms[v].t];if(y!==undefined){x=y.call(this,z,[this.atoms[w].t,this.atoms[v].t]);u.scale(x/z);this.atoms[w].f.add(u);this.atoms[v].f.sub(u)}}}}for(w=0;w<this.atoms.length;++w){for(v=0;v<this.barriers.length;++v){u=this.barriers[v].dist(this.atoms[w].p);z=u.pbclen(this.w,this.h);if(z<this.rc){y=this.interaction[this.atoms[w].t][this.barriers[v].t];if(y!==undefined){x=y.call(this,z,[this.atoms[w].t,this.barriers[v].t]);console.log(z+","+y);u.scale(x/z);this.atoms[w].f.add(u);this.barriers[v].f.sub(u)}}}}};o.prototype.velocityVerlet=function(){var u,w=this.dt,t,x,A=0,y=0,v=0,z=new jsmd.Vector();for(u=0;u<this.atoms.length;++u){t=this.types[this.atoms[u].t].m;z.set(this.atoms[u].v);z.scale(w);z.add(jsmd.Vector.scale(this.atoms[u].f,0.5/t*w*w));this.atoms[u].p.add(z);this.atoms[u].p.wrap(this.w,this.h);this.atoms[u].v.add(jsmd.Vector.scale(this.atoms[u].f,0.5/t*w));A=Math.max(A,z.len2())}this.updateNeighborlist(Math.sqrt(A));this.updateForces();for(u=0;u<this.atoms.length;++u){this.atoms[u].v.add(jsmd.Vector.scale(this.atoms[u].f,0.5/t*w));this.atoms[u].v.scale(this.drag);y=Math.max(y,this.atoms[u].v.len2());v=Math.max(v,this.atoms[u].f.len2()/(0.25*t*t))}this.step++;this.time+=w;x=0.025;y=Math.sqrt(y);v=Math.sqrt(v);this.dt=Math.min(0.01,x/y,Math.sqrt(2*x/v))};o.prototype.setCanvas=function(t){this.canvas={node:t,w:t.width,h:t.height,ctx:t.getContext("2d")}};o.prototype.draw=function(){var u=this.canvas.ctx,t;u.setTransform(this.canvas.w/this.w,0,0,this.canvas.h/this.h,0,0);u.fillStyle="rgb(200,200,200)";u.fillRect(0,0,800,500);for(t=0;t<this.renderChain.length;++t){this.renderChain[t].call(this,u)}};function r(A){var t,z,w,v;function u(B,D,C){A.beginPath();A.arc(B,D,C,0,Math.PI*2,true);A.closePath();A.fill()}A.strokeStyle="rgba(0,100,0,0.5)";for(v=0;v<this.atoms.length;++v){A.fillStyle=this.types[this.atoms[v].t].color;t=this.atoms[v].p.x;z=this.atoms[v].p.y;w=this.types[this.atoms[v].t].r;u(t,z,w);if(t<=w||z<=w||t+w>this.w||z+w>this.h){if(t<=w){u(t+this.w,z,w)}if(z<=w){u(t,z+this.h,w)}if(t<=w&&z<=w){u(t+this.w,z+this.h,w)}if(t+w>this.w){u(t-this.w,z,w)}if(z+w>this.h){u(t,z-this.h,w)}if(t+w>this.w&&z+w>this.h){u(t-this.w,z-this.h,w)}}}}function j(u){var t;u.strokeStyle="rgba(0,0,100,1)";for(t=0;t<this.barriers.length;++t){u.beginPath();u.moveTo(this.barriers[t].p[0].x,this.barriers[t].p[0].y);u.lineTo(this.barriers[t].p[1].x,this.barriers[t].p[1].y);u.closePath();u.stroke()}}function p(u){var t;u.strokeStyle="rgba(0,100,0,0.5)";u.lineWidth=0.01;for(t=0;t<this.atoms.length;++t){u.beginPath();u.moveTo(this.atoms[t].p.x,this.atoms[t].p.y);u.lineTo(this.atoms[t].p.x+this.atoms[t].f.x*0.01,this.atoms[t].p.y+this.atoms[t].f.y*0.01);u.closePath();u.stroke()}}function e(w,v){var y=v!==undefined?v:10,x=w!==undefined?w:1,t=Math.pow(x,6),u=t*t;return function(z){z/=4;return 12*y*(t*Math.pow(z,-7)-u*Math.pow(z,-13))}}function l(){return function(t){return -Math.pow(t,-13)}}function c(v,y,x){var w=v!==undefined?v:1.5,u=y!==undefined?y:2,t=x!==undefined?x:1;return function(A){var z=Math.exp(-u*(A-w));return 2*u*t*(1-z)*z}}function f(v,y,x){var w=v!==undefined?v:1.5,u=y!==undefined?y:2,t=x!==undefined?x:1;return function(A){var z=Math.exp(-u*(A-w));return t*(1-z)*(1-z)}}function q(x,w,A){var z=w!==undefined?w:0.01,v=A!==undefined?A:10,y=v/z,u=[],t;for(t=0;t<=y*v+10;++t){u[t]=x.call(this,t/y)}return function(C){C*=y;var B=Math.floor(C);C-=B;return(1-C)*u[B]+C*u[B+1]}}function n(u,t){var v=t!==undefined?t:0.0001;return function(w){return 0.5*(u.call(this,w+v)-u.call(this,w-v))/v}}function b(t,u){}function s(t,w,v,u){}function m(z,y){var u=0.539177,E=0.8854*u/(Math.pow(z,0.23)+Math.pow(y,0.23)),C=1,D=1,w=1/(4*Math.PI*D)*z*y*C*C,v=[0.1818,0.5099,0.2802,0.02817],t=[-3.2,-0.9423,-0.4029,-0.2016];function x(F){var B=0,A;for(A=0;A<4;++A){B+=v[A]*Math.exp(t[A]*F/E)}return w/F*B}return x}return{Atom:h,AtomType:d,Barrier:k,Simulation:o,Vector:a,render:{atoms:r,barriers:j,forces:p},force:{lennardJones:e,wall:l,morse:c,tabulated:q,diff:n},energy:{morse:f,ZBL:m}}})();